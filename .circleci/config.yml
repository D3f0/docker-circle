version: 2
jobs:
  build:
    docker:
      # using custom image, see .circleci/images/primary/Dockerfile
      - image: circleci/python:3.8

    environment:
      TEST_RESULTS: /tmp/test-result

    steps:
      - checkout
      # - run:
      #     name: "Is docker available?"
      #     command: |
      #       which docker || echo "No docker"
      #       which docker-compose || echo "No docker compose"
      - setup_remote_docker:
          docker_layer_caching: false
      - run:
          name: "Docker compose up"
          command: |
            docker-compose up -d
      - run:
          name: "Debug contents"
          command: |
            docker-compose run django find /src
      - run:
          name: "Install packages"
          command: |
            docker-compose run django poetry install
      - run:
          name: "Run tests"
          command: |
            docker-compose run django python -m pytest




  # - run:
  #     name: Install Docker client
  #     command: |
  #       set -x
  #       VER="17.03.0-ce"
  #       curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
  #       tar -xz -C /tmp -f /tmp/docker-$VER.tgz
  #       sudo mv /tmp/docker/* /usr/bin
  # - run:
  #     name: Install Docker Compose
  #     command: |
  #       set -x
  #       curl -L https://github.com/docker/compose/releases/download/1.11.2/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
  #       chmod +x /usr/local/bin/docker-compose
